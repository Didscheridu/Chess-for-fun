<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Schach Pro (Animiert)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #212121; color: #ecf0f1; text-align: center; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Container */
        .screen { width: 95%; max-width: 450px; padding: 20px; background: #2c3e50; border-radius: 12px; margin-top: 20px; display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.6); transition: all 0.3s; }
        .active { display: block; animation: fadeIn 0.5s; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Inputs & Buttons */
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: none; font-size: 16px; box-sizing: border-box; }
        button { padding: 12px; margin: 5px 0; border-radius: 6px; border: none; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-green { background: #27ae60; color: white; } 
        .btn-blue { background: #2980b9; color: white; }
        .btn-red { background: #c0392b; color: white; }

        /* SCHACHBRETT & ANIMATIONEN */
        #board { width: 100%; margin: 15px 0; border: 5px solid #34495e; border-radius: 4px; }
        
        /* Highlight Klasse f√ºr den letzten Zug */
        .highlight-move { box-shadow: inset 0 0 3px 3px yellow; }

        /* Shake Animation beim Schlagen */
        .shake-board { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Analyse Anzeige */
        .analysis-box { margin-top: 10px; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .grade-brilliant { color: #2ecc71; text-shadow: 0 0 10px #2ecc71; font-weight: bold; }
        .grade-bad { color: #e74c3c; text-shadow: 0 0 10px #e74c3c; font-weight: bold; }
        .grade-normal { color: #bdc3c7; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1 style="color:#f1c40f">Schach Login</h1>
        <input type="text" id="reg-username" placeholder="Dein Spielername">
        <input type="email" id="reg-email" placeholder="E-Mail">
        <input type="password" id="reg-password" placeholder="Passwort">
        <div style="display:flex; gap:10px;">
            <button class="btn-green" onclick="doRegister()">Konto erstellen</button>
            <button class="btn-blue" onclick="doLogin()">Einloggen</button>
        </div>
        <p id="error-msg" style="color:#e74c3c"></p>
    </div>

    <div id="lobby-screen" class="screen">
        <h3>Willkommen, <span id="display-name" style="color:#f1c40f">Spieler</span>!</h3>
        
        <button class="btn-blue" onclick="startBotGame()">ü§ñ Gegen Bot spielen</button>
        
        <div style="margin: 20px 0; border-top: 1px solid #555; padding-top:20px;">
            <label>Online Multiplayer:</label>
            <input type="text" id="room-id" placeholder="Raum Name (z.B. 'Arena1')">
            <div style="display:flex; gap:10px;">
                <button class="btn-green" onclick="startOnlineGame('white')">Wei√ü (Starten)</button>
                <button class="btn-green" style="background:#7f8c8d" onclick="startOnlineGame('black')">Schwarz (Beitreten)</button>
            </div>
        </div>
        <button class="btn-red" onclick="logout()" style="margin-top:10px;">Abmelden</button>
    </div>

    <div id="game-screen" class="screen" style="max-width: 550px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="game-title" style="font-weight:bold; color:#f1c40f">Spiel l√§uft</span>
            <button class="btn-red" style="width:auto; padding:5px 12px;" onclick="leaveGame()">Verlassen</button>
        </div>
        
        <div id="board"></div>
        
        <div class="analysis-box">
            <span id="feedback-icon" style="font-size:1.4em;">‚öñÔ∏è</span>
            <span id="feedback-text">Spiel beginnt...</span>
        </div>
    </div>

    <script>
        // ======================================================
        // DEINE API DATEN SIND HIER EINGEBAUT:
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAwQMhOL1tBQfU5EivFfomrTLf2dINYRZs",
            authDomain: "chess-server-d09b1.firebaseapp.com",
            projectId: "chess-server-d09b1",
            storageBucket: "chess-server-d09b1.firebasestorage.app",
            messagingSenderId: "354655053561",
            appId: "1:354655053561:web:43ea29ed1f01ee366f6428",
            measurementId: "G-B2WK6GD8Z0"
        };

        // Init
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        let game = new Chess();
        let board = null;
        let isOnline = false, isBot = false;
        let myColor = 'w', currentRoom = '';
        let previousScore = 0;

        // BILDER FIX (Wikipedia Style)
        function pieceTheme(piece) {
            return 'https://chessboardjs.com/img/chesspieces/wikipedia/' + piece + '.png';
        }

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                $('.screen').removeClass('active');
                $('#lobby-screen').addClass('active');
                db.ref('users/' + user.uid).once('value').then(snap => {
                    let n = snap.val() && snap.val().username ? snap.val().username : "Spieler";
                    $('#display-name').text(n);
                });
            } else {
                $('.screen').removeClass('active');
                $('#login-screen').addClass('active');
            }
        });
        function doRegister() {
            let u=$('#reg-username').val(), e=$('#reg-email').val(), p=$('#reg-password').val();
            if(!u) return alert("Name fehlt!");
            auth.createUserWithEmailAndPassword(e,p).then(c=>{
                db.ref('users/'+c.user.uid).set({username:u, email:e});
            }).catch(er=>$('#error-msg').text(er.message));
        }
        function doLogin() {
            auth.signInWithEmailAndPassword($('#reg-email').val(), $('#reg-password').val())
            .catch(er=>$('#error-msg').text(er.message));
        }
        function logout() { auth.signOut(); }

        // --- BOARD LOGIK ---
        function initBoard(type) {
            game.reset();
            previousScore = 0;
            $('#feedback-text').text("Viel Erfolg!");
            $('#feedback-icon').text("üèÅ");
            
            // Animation: Highlighting entfernen
            $('#board .square-55d63').removeClass('highlight-move');

            const config = {
                draggable: true,
                position: 'start',
                pieceTheme: pieceTheme,
                moveSpeed: 'slow', // Langsame, geschmeidige Bewegung
                snapBackSpeed: 500,
                snapSpeed: 100,
                onDragStart: onDragStart,
                onDrop: type === 'bot' ? onDropBot : onDropOnline,
                onSnapEnd: () => board.position(game.fen())
            };
            board = Chessboard('board', config);
        }

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if (isBot && (game.turn() === 'b' || piece.search(/^b/) !== -1)) return false;
            if (isOnline) {
                if (game.turn() !== myColor.charAt(0)) return false;
                if ((myColor === 'white' && piece.search(/^b/) !== -1) || 
                    (myColor === 'black' && piece.search(/^w/) !== -1)) return false;
            }
        }

        // --- VISUAL EFFECTS (HIGHLIGHT & SHAKE) ---
        function triggerEffects(move, source, target) {
            // 1. Highlighting (Gelb f√ºr letzten Zug)
            $('#board .square-55d63').removeClass('highlight-move');
            $('#board .square-' + source).addClass('highlight-move');
            $('#board .square-' + target).addClass('highlight-move');

            // 2. Shake bei Capture (Schlagen)
            if (move.captured) {
                const boardEl = $('#board');
                boardEl.addClass('shake-board');
                setTimeout(() => boardEl.removeClass('shake-board'), 500); // Shake wieder entfernen
            }
        }

        // --- ANALYSE ---
        function updateAnalysis(move) {
            let scoreNow = calculateScore();
            let diff = scoreNow - previousScore;
            previousScore = scoreNow;
            
            // Perspektive drehen wenn Schwarz zieht
            if (game.turn() === 'w') diff = diff * -1; // Schwarz hat gezogen

            let txt = "Normaler Zug", ico = "üëå", cls = "grade-normal";
            
            if (move.captured) { txt = "Geschlagen!"; ico = "‚öîÔ∏è"; }
            if (diff >= 3) { txt = "Brillant!"; ico = "üî•"; cls = "grade-brilliant"; }
            else if (diff <= -3) { txt = "Patzer (Figur weg)"; ico = "üò±"; cls = "grade-bad"; }
            
            if (game.in_checkmate()) { txt = "SCHACHMATT"; ico = "üèÜ"; cls = "grade-brilliant"; }
            else if (game.in_check()) { txt = "Schach!"; ico = "‚ö†Ô∏è"; cls = "grade-brilliant"; }

            $('#feedback-text').text(txt).attr('class', cls);
            $('#feedback-icon').text(ico);
        }

        function calculateScore() {
            let fen = game.fen().split(' ')[0], score = 0;
            const val = { p:1, n:3, b:3, r:5, q:9, k:0 };
            for(let c of fen) {
                if(val[c.toLowerCase()]) {
                    score += (c === c.toUpperCase() ? val[c.toLowerCase()] : -val[c.toLowerCase()]);
                }
            }
            return score;
        }

        // --- BOT ---
        function startBotGame() {
            $('.screen').removeClass('active'); $('#game-screen').addClass('active');
            isBot=true; isOnline=false;
            setTimeout(() => initBoard('bot'), 200);
        }
        function onDropBot(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            
            triggerEffects(move, source, target);
            updateAnalysis(move);
            
            window.setTimeout(makeRandomMove, 400); // 400ms warten f√ºr besseres Gef√ºhl
        }
        function makeRandomMove() {
            let moves = game.moves({ verbose: true });
            if (moves.length === 0) return;
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move.san);
            board.position(game.fen());
            triggerEffects(move, move.from, move.to);
            previousScore = calculateScore(); // Sync Score
        }

        // --- ONLINE ---
        function startOnlineGame(side) {
            let r = $('#room-id').val();
            if(!r) return alert("Raumname fehlt!");
            currentRoom=r; myColor=side; isOnline=true; isBot=false;
            $('.screen').removeClass('active'); $('#game-screen').addClass('active');
            
            setTimeout(() => {
                initBoard('online');
                if(side==='black') board.orientation('black');
            }, 200);

            db.ref('games/'+r).on('value', s => {
                let d = s.val();
                if(d && d.fen) {
                    // Pr√ºfen ob es ein neuer Zug ist f√ºr Effekte
                    if (game.fen() !== d.fen) {
                        game.load(d.fen);
                        board.position(d.fen);
                        // Wir wissen hier nicht genau, was der letzte Zug war, daher kein Highlight/Shake f√ºr den Gegner-Zug (einfachheitshalber)
                        previousScore = calculateScore();
                    }
                }
            });
        }
        function onDropOnline(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';
            
            triggerEffects(move, source, target);
            updateAnalysis(move);
            db.ref('games/'+currentRoom).set({ fen: game.fen() });
        }
        function leaveGame() {
            if(isOnline && currentRoom) db.ref('games/'+currentRoom).off();
            $('.screen').removeClass('active'); $('#lobby-screen').addClass('active');
        }
    </script>
</body>
</html>
