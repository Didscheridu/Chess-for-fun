<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Grandmaster Chess Suite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* =========================================
           GLOBALES DESIGN & LAYOUT
           ========================================= */
        :root {
            --bg-color: #121212;
            --panel-color: #1e1e2f;
            --accent-color: #f1c40f;
            --text-color: #ecf0f1;
            --success: #2ecc71;
            --danger: #e74c3c;
            --ocean: #3498db;
            --ruby: #e74c3c;
            --midnight: #8e44ad;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow-x: hidden;
        }
        
        /* Scrollbar Design */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-color); }

        .screen { 
            width: 100%; max-width: 900px; 
            min-height: 600px;
            background: var(--panel-color); 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.6); 
            display: none; 
            overflow: hidden;
            position: relative;
            animation: fadeScale 0.4s ease-out;
        }
        .active { display: flex; flex-direction: column; }
        
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* =========================================
           ELEMENTE & BUTTONS
           ========================================= */
        h1, h2 { text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        h1 { color: var(--accent-color); font-size: 2.5rem; text-shadow: 0 0 15px rgba(241,196,15,0.3); }
        
        input { 
            background: #2a2a40; border: 1px solid #444; color: white; 
            padding: 15px; border-radius: 8px; width: 100%; box-sizing: border-box; 
            margin-bottom: 10px; font-size: 1rem; transition: 0.3s;
        }
        input:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 10px rgba(241,196,15,0.2); }

        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s; width: 100%; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.2); }
        .btn:active { transform: scale(0.98); }

        .btn-main { background: linear-gradient(135deg, #f1c40f, #e67e22); color: #222; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-dark { background: #34495e; color: #ccc; }

        /* =========================================
           SCREEN: LOGIN
           ========================================= */
        #login-screen { justify-content: center; align-items: center; text-align: center; padding: 40px; }
        .login-box { width: 100%; max-width: 400px; }

        /* =========================================
           SCREEN: LOBBY & SETTINGS
           ========================================= */
        .lobby-layout { display: grid; grid-template-columns: 250px 1fr; height: 100%; flex: 1; }
        
        .sidebar { 
            background: #151520; padding: 20px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #333;
        }
        .user-profile { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .avatar-circle { 
            width: 80px; height: 80px; background: var(--accent-color); border-radius: 50%; 
            margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; font-size: 2rem; color: #222;
        }
        
        .main-content { padding: 40px; overflow-y: auto; }
        
        .stat-card { background: #2a2a40; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* =========================================
           SCREEN: GAME
           ========================================= */
        .game-layout { display: grid; grid-template-columns: 1fr 300px; height: 100%; }
        .board-area { display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; position: relative; }
        .info-area { background: #151520; padding: 20px; border-left: 1px solid #333; display: flex; flex-direction: column; }

        #board-container { 
            width: 500px; height: 500px; position: relative; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 4px;
        }
        #board { width: 100%; height: 100%; }

        .player-hud { width: 500px; display: flex; justify-content: space-between; padding: 10px; background: #222; margin: 5px 0; border-radius: 5px; }
        .move-history { flex: 1; background: #222; margin: 20px 0; border-radius: 8px; overflow-y: auto; padding: 10px; font-family: monospace; }
        .move-row { display: flex; border-bottom: 1px solid #333; padding: 5px; }
        .move-num { width: 30px; color: #777; }
        .move-val { width: 80px; color: #ddd; }

        /* =========================================
           SKINS CSS
           ========================================= */
        .skin-classic .white-1e1d7 { background-color: #e8e8e8; color: #888; }
        .skin-classic .black-3c85d { background-color: #888; color: #e8e8e8; }
        
        .skin-ocean .white-1e1d7 { background-color: #d1ecf1; }
        .skin-ocean .black-3c85d { background-color: #17a2b8; }

        .skin-ruby .white-1e1d7 { background-color: #fadbd8; }
        .skin-ruby .black-3c85d { background-color: #c0392b; }

        .skin-midnight .white-1e1d7 { background-color: #7f8c8d; }
        .skin-midnight .black-3c85d { background-color: #2c3e50; }

        .skin-gold .white-1e1d7 { background-color: #fcf3cf; }
        .skin-gold .black-3c85d { background-color: #f1c40f; }

        /* Highlight & Dots */
        .highlight-move { box-shadow: inset 0 0 0 4px rgba(255, 255, 0, 0.7) !important; }
        .possible-move { background: radial-gradient(rgba(46, 204, 113, 0.8) 19%, transparent 20%); cursor: pointer; }

        /* =========================================
           KILL ANIMATIONEN (THE COOL STUFF)
           ========================================= */
        .kill-effect {
            position: absolute;
            width: 62.5px; height: 62.5px; /* 1/8 von 500px Board */
            pointer-events: none;
            z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }

        /* 1. CLASSIC: DUST */
        .anim-classic::after {
            content: ''; width: 10px; height: 10px; background: #aaa; border-radius: 50%;
            box-shadow: 0 0 10px #fff;
            animation: dustPuff 0.6s ease-out forwards;
        }
        @keyframes dustPuff {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(200,200,200,0.8); }
            100% { transform: scale(4); opacity: 0; box-shadow: 0 0 20px 20px rgba(200,200,200,0); }
        }

        /* 2. OCEAN: SPLASH */
        .anim-ocean { background: radial-gradient(circle, rgba(52,152,219,0.8) 0%, rgba(52,152,219,0) 70%); animation: splash 0.8s ease-out forwards; border-radius: 50%; }
        @keyframes splash { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }

        /* 3. RUBY: SHATTER */
        .anim-ruby::before, .anim-ruby::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            background: rgba(231, 76, 60, 0.6);
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: shatter 0.5s ease-out forwards;
        }
        .anim-ruby::after { transform: rotate(180deg); animation-delay: 0.1s; }
        @keyframes shatter { 0% { transform: scale(0) rotate(0); opacity:1; } 100% { transform: scale(2) rotate(180deg); opacity: 0; } }

        /* 4. MIDNIGHT: BLACK HOLE */
        .anim-midnight { background: black; border-radius: 50%; box-shadow: 0 0 20px #8e44ad; animation: implosion 0.8s ease-in-out forwards; }
        @keyframes implosion { 0% { transform: scale(0); opacity:0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }

        /* 5. GOLD: COINS */
        .anim-gold::after { 
            content: 'ðŸª™'; font-size: 30px; animation: coinSpin 1s ease-out forwards; 
            text-shadow: 0 0 10px gold;
        }
        @keyframes coinSpin { 0% { transform: translateY(0) rotateY(0); opacity:1; } 100% { transform: translateY(-50px) rotateY(720deg); opacity: 0; } }

        /* =========================================
           SETTINGS MENÃœ
           ========================================= */
        #settings-screen .setting-group { background: #2a2a40; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* Toggle Switch */
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* =========================================
           SHOP GRID
           ========================================= */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .skin-card { 
            background: #222; border-radius: 8px; overflow: hidden; border: 2px solid transparent; 
            transition: 0.3s; cursor: pointer; position: relative;
        }
        .skin-card:hover { transform: translateY(-5px); border-color: #666; }
        .skin-card.selected { border-color: var(--accent-color); box-shadow: 0 0 15px rgba(241,196,15,0.4); }
        .skin-preview { height: 80px; width: 100%; }
        .skin-info { padding: 10px; text-align: center; }

    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="login-box">
            <h1>Chess Grandmaster</h1>
            <p style="color:#aaa; margin-bottom: 30px;">Die ultimative Schach-Suite</p>
            
            <input type="text" id="reg-username" placeholder="Benutzername">
            <input type="email" id="reg-email" placeholder="E-Mail Adresse">
            <input type="password" id="reg-password" placeholder="Passwort">
            
            <button class="btn btn-main" onclick="doRegister()"><i class="fas fa-user-plus"></i> Konto erstellen</button>
            <button class="btn btn-info" onclick="doLogin()"><i class="fas fa-sign-in-alt"></i> Einloggen</button>
            
            <p id="auth-error" style="color: var(--danger); margin-top: 10px;"></p>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-layout">
            <div class="sidebar">
                <div class="user-profile">
                    <div class="avatar-circle"><i class="fas fa-chess-king"></i></div>
                    <h3 id="display-name">Spieler</h3>
                    <small id="display-email" style="color:#777">user@mail.com</small>
                </div>
                
                <button class="btn btn-dark" onclick="showSection('home')"><i class="fas fa-home"></i> Home</button>
                <button class="btn btn-dark" onclick="showSection('shop')"><i class="fas fa-store"></i> Skin Shop</button>
                <button class="btn btn-dark" onclick="showSection('settings')"><i class="fas fa-cog"></i> Einstellungen</button>
                <div style="flex:1"></div>
                <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>

            <div class="main-content">
                
                <div id="section-home">
                    <h2>Ãœbersicht</h2>
                    <div class="stat-card">
                        <span><i class="fas fa-trophy" style="color:gold"></i> Siege</span>
                        <strong style="font-size:1.5rem" id="stat-wins">0</strong>
                    </div>
                    <div class="stat-card">
                        <span><i class="fas fa-coins" style="color:gold"></i> MÃ¼nzen</span>
                        <strong style="font-size:1.5rem" id="stat-coins">0</strong>
                    </div>

                    <h3 style="margin-top:30px">Spiel starten</h3>
                    <button class="btn btn-info" onclick="startBotGame()">ðŸ¤– Gegen Bot trainieren</button>
                    
                    <div style="background:#222; padding:15px; border-radius:8px; margin-top:15px;">
                        <label>Multiplayer Raum:</label>
                        <input type="text" id="room-id" placeholder="z.B. 'Arena1'" style="margin-top:5px;">
                        <div style="display:flex; gap:10px;">
                            <button class="btn btn-success" onclick="startOnlineGame('white')">Als WeiÃŸ</button>
                            <button class="btn btn-dark" onclick="startOnlineGame('black')">Als Schwarz</button>
                        </div>
                    </div>
                </div>

                <div id="section-shop" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>Skin Shop</h2>
                        <span style="color:gold; font-size:1.2rem;"><i class="fas fa-coins"></i> <span id="shop-coins">0</span></span>
                    </div>
                    <div class="shop-grid" id="skin-grid">
                        </div>
                </div>

                <div id="section-settings" style="display:none;">
                    <h2>Einstellungen</h2>
                    
                    <div class="setting-group">
                        <h3><i class="fas fa-user-edit"></i> Profil Ã¤ndern</h3>
                        <label>Neuer Benutzername:</label>
                        <input type="text" id="new-username" placeholder="Neuer Name">
                        <button class="btn btn-info" onclick="updateUsername()">Speichern</button>
                    </div>

                    <div class="setting-group">
                        <h3><i class="fas fa-key"></i> Sicherheit</h3>
                        <label>Neues Passwort:</label>
                        <input type="password" id="new-password" placeholder="Mind. 6 Zeichen">
                        <button class="btn btn-danger" onclick="updateUserPassword()">Passwort Ã¤ndern</button>
                    </div>

                    <div class="setting-group">
                        <h3><i class="fas fa-sliders-h"></i> Spieloptionen</h3>
                        <div class="toggle-row">
                            <span>Sound Effekte</span>
                            <label class="switch"><input type="checkbox" id="toggle-sound" checked><span class="slider"></span></label>
                        </div>
                        <div class="toggle-row">
                            <span>Brett-Koordinaten anzeigen</span>
                            <label class="switch"><input type="checkbox" id="toggle-coords" checked><span class="slider"></span></label>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="game-screen" class="screen" style="max-width:1100px;">
        <div class="game-layout">
            
            <div class="board-area">
                <div class="player-hud">
                    <span><i class="fas fa-user-secret"></i> Gegner</span>
                    <span id="enemy-material"></span>
                </div>
                
                <div id="board-container">
                    <div id="board"></div>
                    <div id="effects-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>
                </div>

                <div class="player-hud">
                    <span><i class="fas fa-user"></i> <span id="game-my-name">Ich</span></span>
                    <span id="my-material"></span>
                </div>
            </div>

            <div class="info-area">
                <h3 style="color:var(--accent-color)">Status</h3>
                <div id="status-text" style="margin-bottom:10px; font-weight:bold;">Warte auf Spiel...</div>
                
                <div class="move-history" id="move-list">
                    </div>

                <div style="margin-top:auto;">
                    <div id="coin-reward-display" style="text-align:center; color:gold; height:30px; font-weight:bold;"></div>
                    <button class="btn btn-danger" onclick="leaveGame()">Spiel Verlassen</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // =================================================================
        // 1. FIREBASE KONFIGURATION (Dein Key ist eingebaut)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAwQMhOL1tBQfU5EivFfomrTLf2dINYRZs",
            authDomain: "chess-server-d09b1.firebaseapp.com",
            projectId: "chess-server-d09b1",
            storageBucket: "chess-server-d09b1.firebasestorage.app",
            messagingSenderId: "354655053561",
            appId: "1:354655053561:web:43ea29ed1f01ee366f6428",
            measurementId: "G-B2WK6GD8Z0"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // =================================================================
        // 2. GLOBALE VARIABLEN & DATEN
        // =================================================================
        let game = new Chess();
        let board = null;
        let isOnline = false, isBot = false;
        let myColor = 'w', currentRoom = '';
        let selectedSquare = null;
        let previousScore = 0;
        
        // User Default Data
        let userData = { 
            username: "Gast", wins: 0, coins: 0, 
            skin: 'classic', unlockedSkins: ['classic'],
            settings: { sound: true, coords: true }
        };

        // SKINS DATENBANK
        const SKINS = {
            'classic': { name: 'Klassisch', cost: 0, css: 'skin-classic', colors: ['#e8e8e8', '#888'], anim: 'anim-classic' },
            'ocean':   { name: 'Ozean Welle', cost: 200, css: 'skin-ocean', colors: ['#d1ecf1', '#17a2b8'], anim: 'anim-ocean' },
            'ruby':    { name: 'Rubin Splitter', cost: 500, css: 'skin-ruby', colors: ['#fadbd8', '#c0392b'], anim: 'anim-ruby' },
            'midnight':{ name: 'Schwarzes Loch', cost: 1000, css: 'skin-midnight', colors: ['#7f8c8d', '#2c3e50'], anim: 'anim-midnight' },
            'gold':    { name: 'Goldregen', cost: 3000, css: 'skin-gold', colors: ['#fcf3cf', '#f1c40f'], anim: 'anim-gold' }
        };

        // =================================================================
        // 3. AUTH SYSTEM (LOGIN / REGISTER / UPDATE)
        // =================================================================
        auth.onAuthStateChanged(user => {
            if (user) {
                switchScreen('lobby-screen');
                // Live Listener auf Userdaten
                db.ref('users/' + user.uid).on('value', snap => {
                    let val = snap.val() || {};
                    userData = {
                        username: val.username || user.email.split('@')[0],
                        wins: val.wins || 0,
                        coins: val.coins || 0,
                        skin: val.skin || 'classic',
                        unlockedSkins: val.unlockedSkins || ['classic'],
                        settings: val.settings || { sound: true, coords: true }
                    };
                    updateLobbyUI();
                });
            } else {
                switchScreen('login-screen');
            }
        });

        function doRegister() {
            let u=$('#reg-username').val(), e=$('#reg-email').val(), p=$('#reg-password').val();
            if(!u || !e || !p) return showError("Bitte alles ausfÃ¼llen.");
            
            auth.createUserWithEmailAndPassword(e, p).then(cred => {
                db.ref('users/'+cred.user.uid).set({
                    username: u, email: e, wins: 0, coins: 0, skin: 'classic', unlockedSkins: ['classic'],
                    settings: { sound: true, coords: true }
                });
            }).catch(err => showError(err.message));
        }

        function doLogin() {
            auth.signInWithEmailAndPassword($('#reg-email').val(), $('#reg-password').val())
            .catch(err => showError(err.message));
        }

        function logout() { auth.signOut(); window.location.reload(); }
        function showError(msg) { $('#auth-error').text(msg); }

        // --- SETTINGS FUNKTIONEN ---
        function updateUsername() {
            let newName = $('#new-username').val();
            if(!newName) return alert("Name darf nicht leer sein");
            db.ref('users/'+auth.currentUser.uid).update({ username: newName });
            alert("Name gespeichert!");
            $('#new-username').val('');
        }

        function updateUserPassword() {
            let newPass = $('#new-password').val();
            if(newPass.length < 6) return alert("Passwort zu kurz (min 6).");
            auth.currentUser.updatePassword(newPass)
                .then(() => alert("Passwort geÃ¤ndert!"))
                .catch(err => alert("Fehler: " + err.message));
            $('#new-password').val('');
        }

        // Toggle Listener fÃ¼r Einstellungen speichern
        $('#toggle-sound').change(function() {
            userData.settings.sound = this.checked;
            saveSettings();
        });
        $('#toggle-coords').change(function() {
            userData.settings.coords = this.checked;
            saveSettings();
            // Wenn Board da ist, update Config
            if(board) { /* Board mÃ¼sste neu geladen werden fÃ¼r Koordinaten update, machen wir beim nÃ¤chsten Start */ }
        });

        function saveSettings() {
            db.ref('users/'+auth.currentUser.uid+'/settings').set(userData.settings);
        }

        // =================================================================
        // 4. UI NAVIGATION & SHOP
        // =================================================================
        function switchScreen(id) {
            $('.screen').removeClass('active');
            $('#' + id).addClass('active');
        }

        function showSection(sec) {
            $('#section-home, #section-shop, #section-settings').hide();
            $('#section-' + sec).fadeIn();
            if(sec === 'shop') renderShop();
            if(sec === 'settings') {
                $('#toggle-sound').prop('checked', userData.settings.sound);
                $('#toggle-coords').prop('checked', userData.settings.coords);
            }
        }

        function updateLobbyUI() {
            $('#display-name').text(userData.username);
            $('#display-email').text(auth.currentUser.email);
            $('#stat-wins').text(userData.wins);
            $('#stat-coins').text(userData.coins);
            $('#shop-coins').text(userData.coins);
        }

        function renderShop() {
            let grid = $('#skin-grid');
            grid.empty();
            Object.keys(SKINS).forEach(key => {
                let skin = SKINS[key];
                let unlocked = userData.unlockedSkins.includes(key);
                let active = userData.skin === key;
                let bgStyle = `linear-gradient(135deg, ${skin.colors[0]}, ${skin.colors[1]})`;
                
                let btn = '';
                if(active) btn = `<button class="btn btn-success" disabled>Aktiv</button>`;
                else if(unlocked) btn = `<button class="btn btn-dark" onclick="equipSkin('${key}')">AusrÃ¼sten</button>`;
                else btn = `<button class="btn btn-main" onclick="buySkin('${key}')">Kaufen ${skin.cost}</button>`;

                let html = `
                <div class="skin-card ${active ? 'selected' : ''}">
                    <div class="skin-preview" style="background:${bgStyle}"></div>
                    <div class="skin-info">
                        <strong>${skin.name}</strong>
                        <div style="margin-top:10px;">${btn}</div>
                    </div>
                </div>`;
                grid.append(html);
            });
        }

        function buySkin(key) {
            let cost = SKINS[key].cost;
            if(userData.coins >= cost) {
                if(confirm(SKINS[key].name + " kaufen?")) {
                    userData.coins -= cost;
                    userData.unlockedSkins.push(key);
                    userData.skin = key;
                    saveUserData();
                }
            } else alert("Zu wenig MÃ¼nzen!");
        }

        function equipSkin(key) {
            userData.skin = key;
            saveUserData();
        }

        function saveUserData() {
            db.ref('users/'+auth.currentUser.uid).update({
                coins: userData.coins, skin: userData.skin, unlockedSkins: userData.unlockedSkins
            });
        }

        // =================================================================
        // 5. GAME ENGINE & BOARD LOGIC
        // =================================================================
        function pieceTheme(piece) {
            return 'https://chessboardjs.com/img/chesspieces/wikipedia/' + piece + '.png';
        }

        function initGame(type) {
            game.reset();
            selectedSquare = null;
            previousScore = 0;
            $('#move-list').empty();
            $('#effects-layer').empty();
            $('#game-my-name').text(userData.username);
            
            // Apply Skin
            $('#board').removeClass().addClass(SKINS[userData.skin].css);
            
            board = Chessboard('board', {
                draggable: true,
                position: 'start',
                pieceTheme: pieceTheme,
                moveSpeed: 'slow',
                snapBackSpeed: 500,
                snapSpeed: 100,
                showNotation: userData.settings.coords, // Setting nutzen
                onDragStart: onDragStart,
                onDrop: type === 'bot' ? onDropBot : onDropOnline,
                onSnapEnd: () => board.position(game.fen())
            });

            // Click Handler
            $('#board').off('click').on('click', '.square-55d63', function() {
                handleSquareClick($(this).attr('data-square'));
            });

            updateStatus();
        }

        // --- KILL ANIMATION TRIGGER ---
        function triggerKillAnimation(square) {
            if(!userData.settings.sound) { /* Sound off */ } // Falls wir Sounds hÃ¤tten
            
            // 1. Position finden
            let $sq = $('#board .square-' + square);
            if($sq.length === 0) return;
            let offset = $sq.position(); // Relativ zum Board Container
            
            // 2. Effekt DIV erstellen
            let animClass = SKINS[userData.skin].anim;
            let $effect = $('<div class="kill-effect ' + animClass + '"></div>');
            
            // 3. Positionieren
            $effect.css({ top: offset.top, left: offset.left });
            
            // 4. EinfÃ¼gen & Entfernen
            $('#effects-layer').append($effect);
            setTimeout(() => $effect.remove(), 1000); // Nach 1s lÃ¶schen
        }

        // --- KLICK LOGIK ---
        function handleSquareClick(square) {
            if (selectedSquare !== null) {
                let move = attemptMove(selectedSquare, square);
                if (move) return;
            }
            
            let piece = game.get(square);
            if (piece && piece.color === game.turn()) {
                if (isOnline && piece.color !== myColor.charAt(0)) return;
                if (isBot && piece.color === 'b') return;

                selectedSquare = square;
                removeHighlights();
                $('#board .square-'+square).addClass('highlight-move');
                game.moves({ square: square, verbose: true }).forEach(m => {
                    $('#board .square-'+m.to).addClass('possible-move');
                });
            } else {
                selectedSquare = null; removeHighlights();
            }
        }

        function removeHighlights() {
            $('#board .square-55d63').removeClass('highlight-move possible-move');
        }

        function onDragStart(source, piece) {
            if (game.game_over()) return false;
            if (isOnline && (game.turn() !== myColor.charAt(0) || piece.charAt(0) !== myColor.charAt(0))) return false;
            if (isBot && piece.search(/^b/) !== -1) return false;
            selectedSquare = null; removeHighlights();
        }

        // --- ZUG AUSFÃœHRUNG ---
        function attemptMove(from, to) {
            let move = null;
            try { move = game.move({ from: from, to: to, promotion: 'q' }); } catch(e) {}
            
            if (move) {
                // WAR EIN FIGUR GESCHLAGEN? -> ANIMATION!
                if(move.captured) {
                    triggerKillAnimation(to);
                }
                
                board.position(game.fen());
                removeHighlights();
                selectedSquare = null;
                
                updateStatus();
                updateHistory(move);
                rewardSystem(move); // MÃ¼nzen & Analyse

                if(isBot && game.turn() === 'b') setTimeout(makeBotMove, 500);
                if(isOnline) db.ref('games/'+currentRoom).set({ fen: game.fen(), lastMove: move });
                
                checkGameOver();
                return true;
            }
            return false;
        }

        // --- LOGIK WRAPPER FÃœR DRAG & DROP ---
        function onDropBot(source, target) {
            if(attemptMove(source, target)) return; else return 'snapback';
        }
        function onDropOnline(source, target) {
            if(attemptMove(source, target)) return; else return 'snapback';
        }

        function makeBotMove() {
            let moves = game.moves({ verbose: true });
            if (moves.length === 0) return;
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move.san);
            
            if(move.captured) triggerKillAnimation(move.to); // Bot killt auch animiert
            
            board.position(game.fen());
            updateStatus();
            updateHistory(move);
            checkGameOver();
        }

        // --- STATUS & HISTORIE ---
        function updateStatus() {
            let s = game.turn() === 'w' ? "WeiÃŸ am Zug" : "Schwarz am Zug";
            if(game.in_check()) s += " (SCHACH!)";
            $('#status-text').text(s);
        }

        function updateHistory(move) {
            // Zugnummer berechnen
            let history = game.history();
            let moveNum = Math.ceil(history.length / 2);
            let isWhite = history.length % 2 !== 0;
            
            if(isWhite) {
                // Neue Zeile
                let html = `<div class="move-row" id="move-${moveNum}">
                    <div class="move-num">${moveNum}.</div>
                    <div class="move-val">${move.san}</div>
                    <div class="move-val" id="black-move-${moveNum}"></div>
                </div>`;
                $('#move-list').append(html);
            } else {
                // Schwarz in bestehende Zeile eintragen
                $(`#black-move-${moveNum}`).text(move.san);
            }
            
            // Scroll nach unten
            let d = $('#move-list');
            d.scrollTop(d.prop("scrollHeight"));
        }

        // --- BELOHNUNGSSYSTEM ---
        function rewardSystem(move) {
            // Nur belohnen wenn ich ziehe
            if(isBot && game.turn() === 'w') return; // Bot hat gezogen
            if(isOnline && game.turn() === myColor.charAt(0)) return; // Gegner hat gezogen

            let coins = 0;
            let txt = "";
            
            // Material Score Check
            let currentScore = getMaterialScore();
            let diff = currentScore - previousScore;
            // Perspektive drehen
            let whoMoved = game.turn() === 'w' ? 'black' : 'white';
            if(whoMoved === 'black') diff *= -1;
            
            previousScore = currentScore;

            if(move.captured && "q".includes(move.captured)) { coins = 10; txt = "KÃ¶niginnen-Killer +10"; }
            else if(diff >= 3) { coins = 5; txt = "Starker Zug +5"; }
            
            if(coins > 0) {
                // Animation im HUD
                let display = $('#coin-reward-display');
                display.html(`<i class="fas fa-coins"></i> ${txt}`).css('opacity', 1);
                setTimeout(()=>display.css('opacity',0), 2000);
                
                // DB Update
                let uid = auth.currentUser.uid;
                db.ref('users/'+uid+'/coins').transaction(c => (c||0)+coins);
            }
        }

        function checkGameOver() {
            if(game.game_over()) {
                let msg = "";
                let win = false;
                if(game.in_checkmate()) {
                    let winner = game.turn() === 'w' ? 'black' : 'white';
                    msg = "SCHACHMATT - " + (winner==='white'?'WeiÃŸ':'Schwarz') + " gewinnt!";
                    
                    // Bin ich der Gewinner?
                    if(isBot && winner === 'white') win=true;
                    if(isOnline && winner === myColor) win=true;
                } else if(game.in_draw()) {
                    msg = "Unentschieden (Remis)";
                }

                if(win) {
                    alert("GEWONNEN! +50 MÃ¼nzen, +1 Sieg");
                    let uid = auth.currentUser.uid;
                    db.ref('users/'+uid).transaction(d => {
                        if(d) { d.wins++; d.coins+=50; } return d;
                    });
                } else {
                    alert("SPIEL VORBEI: " + msg);
                }
            }
        }

        function getMaterialScore() {
            let fen = game.fen().split(' ')[0];
            let s = 0, v = {p:1, n:3, b:3, r:5, q:9, k:0};
            for(let c of fen) if(v[c.toLowerCase()]) s += (c===c.toUpperCase()?v[c.toLowerCase()]:-v[c.toLowerCase()]);
            return s;
        }

        // --- START WRAPPER ---
        function startBotGame() {
            switchScreen('game-screen'); isBot=true; isOnline=false;
            setTimeout(() => initGame('bot'), 200);
        }

        function startOnlineGame(side) {
            let r = $('#room-id').val(); if(!r) return alert("Raumname fehlt!");
            currentRoom = r; myColor = side; isOnline = true; isBot = false;
            switchScreen('game-screen');
            setTimeout(() => {
                initGame('online');
                if(side==='black') board.orientation('black');
            }, 200);
            
            db.ref('games/'+r).off();
            db.ref('games/'+r).on('value', snap => {
                let d = snap.val();
                if(d && d.fen && d.fen !== game.fen()) {
                    game.load(d.fen);
                    board.position(d.fen);
                    if(d.lastMove && d.lastMove.captured) triggerKillAnimation(d.lastMove.to);
                    updateHistory(d.lastMove || {san:"..."});
                    updateStatus();
                    checkGameOver();
                }
            });
        }

        function leaveGame() {
            if(isOnline) db.ref('games/'+currentRoom).off();
            switchScreen('lobby-screen');
        }

    </script>
</body>
</html>
