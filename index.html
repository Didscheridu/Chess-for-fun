<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>CHESS ULTIMATE: Ranks, Chat & Particles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <style>
        /* =========================================
           1. CORE DESIGN SYSTEM & VARIABLES
           ========================================= */
        :root {
            --bg-dark: #0b0c10;
            --bg-panel: #1f2833;
            --accent: #66fcf1; /* Cyber Blue */
            --accent-dim: #45a29e;
            --text-main: #c5c6c7;
            --text-white: #ffffff;
            --gold: #ffd700;
            --danger: #ff4757;
            --success: #2ed573;
            --glass: rgba(31, 40, 51, 0.95);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            overflow: hidden; /* Prevent scrolling globally */
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Scrollbars */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--accent-dim); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* =========================================
           2. UI COMPONENTS
           ========================================= */
        .screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark);
            display: none; flex-direction: column;
            overflow-y: auto;
            z-index: 10;
        }
        .screen.active { display: flex; animation: fadeIn 0.5s; }

        h1, h2, h3 { color: var(--text-white); text-transform: uppercase; letter-spacing: 2px; margin: 0 0 15px 0; }
        h1 span { color: var(--accent); }

        /* Buttons */
        .btn {
            padding: 12px 24px; border: none; border-radius: 4px;
            font-weight: 700; font-size: 14px; text-transform: uppercase; cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 252, 241, 0.3); }
        .btn:active { transform: scale(0.98); }
        
        .btn-primary { background: var(--accent); color: var(--bg-dark); }
        .btn-secondary { background: transparent; border: 2px solid var(--accent-dim); color: var(--accent); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-gold { background: linear-gradient(45deg, #ffd700, #ffa502); color: #000; }
        
        .btn-icon { width: 40px; height: 40px; padding: 0; border-radius: 50%; }

        /* Inputs */
        .input-group { margin-bottom: 15px; width: 100%; }
        input {
            width: 100%; padding: 15px; background: rgba(255,255,255,0.05);
            border: 1px solid #333; border-radius: 4px; color: white;
            font-size: 16px; box-sizing: border-box; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); outline: none; background: rgba(255,255,255,0.1); }

        /* Cards */
        .card {
            background: var(--bg-panel); padding: 20px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px;
            border-left: 3px solid var(--accent-dim);
        }

        /* =========================================
           3. LAYOUTS (LOBBY & GAME)
           ========================================= */
        .container { max-width: 1200px; margin: 0 auto; width: 100%; padding: 20px; }
        
        /* Lobby Grid */
        .lobby-grid { display: grid; grid-template-columns: 300px 1fr; gap: 20px; height: 90vh; }
        .sidebar { background: var(--bg-panel); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; }
        .main-area { overflow-y: auto; padding-right: 10px; }

        /* Profile Section */
        .profile-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .rank-badge { 
            background: linear-gradient(45deg, var(--accent), #2980b9); color: #fff; 
            padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold;
            display: inline-block; margin-top: 5px; box-shadow: 0 0 10px rgba(102, 252, 241, 0.4);
        }
        .stats-row { display: flex; justify-content: space-between; margin-top: 15px; font-size: 0.9em; }

        /* Friend List */
        .friend-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px; background: rgba(0,0,0,0.2); margin-bottom: 5px; border-radius: 4px;
        }
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .is-online { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .is-offline { background: #555; }

        /* Game Layout */
        .game-layout { display: flex; gap: 20px; height: 100vh; align-items: center; justify-content: center; padding: 20px; }
        .game-sidebar { width: 300px; background: var(--bg-panel); height: 600px; border-radius: 8px; display: flex; flex-direction: column; }
        
        #board-wrapper { 
            position: relative; 
            padding: 10px; background: var(--bg-panel); border-radius: 8px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #board { width: 600px; height: 600px; }

        /* Chat */
        .chat-box { flex: 1; display: flex; flex-direction: column; border-top: 1px solid #333; overflow: hidden; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        .chat-msg { margin-bottom: 8px; word-wrap: break-word; }
        .msg-system { color: var(--accent); font-style: italic; font-size: 12px; text-align: center; margin: 10px 0; }
        .msg-me { text-align: right; color: #fff; }
        .msg-opp { text-align: left; color: #aaa; }
        .chat-input-area { display: flex; padding: 10px; background: rgba(0,0,0,0.2); }

        /* =========================================
           4. VISUAL FX (PARTICLES & SKINS)
           ========================================= */
        /* Skin: Neon/Cyberpunk (Default) */
        .skin-cyber .white-1e1d7 { background-color: #e0e0e0; color: #333; }
        .skin-cyber .black-3c85d { background-color: #45a29e; color: #fff; }
        
        .skin-ruby .white-1e1d7 { background-color: #fab1a0; }
        .skin-ruby .black-3c85d { background-color: #d63031; }

        .skin-gold .white-1e1d7 { background-color: #fcf3cf; }
        .skin-gold .black-3c85d { background-color: #ffa502; }

        /* Highlighting */
        .highlight-current { box-shadow: inset 0 0 0 4px var(--accent); }
        .move-hint { background: radial-gradient(rgba(102, 252, 241, 0.6) 20%, transparent 25%); cursor: pointer; }

        /* Particle System */
        .particle {
            position: absolute; pointer-events: none; z-index: 100;
            width: 6px; height: 6px; border-radius: 50%;
        }

        /* =========================================
           5. MODALS & OVERLAYS
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            z-index: 99999; /* Immer oben */
            display: none; justify-content: center; align-items: center;
        }
        
        .modal-content {
            background: var(--bg-panel); width: 400px; padding: 40px;
            border-radius: 12px; text-align: center; border: 1px solid var(--accent);
            box-shadow: 0 0 50px var(--accent-dim);
            animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes zoomIn { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }

        /* Coin Popup Animation */
        .coin-float {
            position: absolute; color: var(--gold); font-size: 24px; font-weight: bold;
            pointer-events: none; z-index: 200; text-shadow: 0 0 10px black;
            animation: floatUp 1.5s forwards;
        }
        @keyframes floatUp { 0%{transform:translateY(0);opacity:1;} 100%{transform:translateY(-100px);opacity:0;} }

    </style>
</head>
<body>

    <div id="screen-login" class="screen active" style="justify-content:center; align-items:center;">
        <div class="card" style="width: 350px; text-align: center;">
            <h1 style="font-size: 2.5em;">CHESS <span>ULTIMATE</span></h1>
            <p style="color:#888; margin-bottom: 30px;">Multiplayer, Chat, Ranglisten</p>
            
            <div class="input-group">
                <input type="text" id="inp-username" placeholder="Spielername">
            </div>
            <div class="input-group">
                <input type="email" id="inp-email" placeholder="E-Mail Adresse">
            </div>
            <div class="input-group">
                <input type="password" id="inp-pass" placeholder="Passwort">
            </div>

            <button class="btn btn-primary" style="width:100%; margin-bottom:10px;" onclick="app.auth.register()">
                <i class="fas fa-user-plus"></i> Konto erstellen
            </button>
            <button class="btn btn-secondary" style="width:100%;" onclick="app.auth.login()">
                <i class="fas fa-sign-in-alt"></i> Einloggen
            </button>
            <p id="msg-login" style="color:var(--danger); margin-top:10px; min-height:20px;"></p>
        </div>
    </div>

    <div id="screen-lobby" class="screen">
        <div class="container">
            <div class="lobby-grid">
                <div class="sidebar">
                    <div class="profile-header">
                        <i class="fas fa-user-astronaut" style="font-size: 3em; color: var(--text-white);"></i>
                        <h2 id="lobby-name" style="margin-top:10px;">Lade...</h2>
                        <div id="lobby-rank" class="rank-badge">Bauer</div>
                        <div class="stats-row">
                            <span><i class="fas fa-trophy" style="color:gold;"></i> <span id="lobby-wins">0</span></span>
                            <span><i class="fas fa-coins" style="color:gold;"></i> <span id="lobby-coins">0</span></span>
                        </div>
                    </div>

                    <h3 style="font-size: 1em; color:#555;">NAVIGATION</h3>
                    <button class="btn btn-secondary" style="justify-content:flex-start; margin-bottom:5px;" onclick="app.ui.showTab('home')">
                        <i class="fas fa-home"></i> Dashboard
                    </button>
                    <button class="btn btn-secondary" style="justify-content:flex-start; margin-bottom:5px;" onclick="app.ui.showTab('shop')">
                        <i class="fas fa-store"></i> Skin Shop
                    </button>
                    
                    <div style="flex:1;"></div>
                    <button class="btn btn-danger" onclick="app.auth.logout()">Abmelden</button>
                </div>

                <div class="main-area">
                    <div id="tab-home">
                        <div class="card">
                            <h2><i class="fas fa-gamepad"></i> Spiel Starten</h2>
                            <div style="display:flex; gap: 15px; margin-top:15px;">
                                <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:4px;">
                                    <h3>Solo / Training</h3>
                                    <p style="font-size:0.9em; color:#aaa;">Trainiere gegen den Computer.</p>
                                    <button class="btn btn-primary" onclick="app.game.startBot()">
                                        <i class="fas fa-robot"></i> Bot Match
                                    </button>
                                </div>
                                <div style="flex:1; background:rgba(0,0,0,0.2); padding:15px; border-radius:4px;">
                                    <h3>Multiplayer</h3>
                                    <input type="text" id="inp-room" placeholder="Raum Name (z.B. 'Berlin')" style="margin-bottom:10px;">
                                    <div style="display:flex; gap:5px;">
                                        <button class="btn btn-primary" onclick="app.game.startOnline('white')">Weiß</button>
                                        <button class="btn btn-secondary" onclick="app.game.startOnline('black')">Schwarz</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h2><i class="fas fa-users"></i> Freunde suchen</h2>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="inp-friend-email" placeholder="E-Mail des Freundes">
                                <button class="btn btn-gold" style="width:auto;" onclick="app.social.addFriend()">Add</button>
                            </div>
                            <div id="friend-list-container" style="margin-top:15px;"></div>
                        </div>
                    </div>

                    <div id="tab-shop" style="display:none;">
                        <h2>Skin Shop</h2>
                        <p>Dein Guthaben: <span id="shop-coins-display" style="color:var(--gold); font-weight:bold;">0</span></p>
                        <div id="shop-items" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px; margin-top:20px;">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-layout">
            
            <div id="board-wrapper">
                <div id="board"></div>
                <div id="particle-layer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:50;"></div>
            </div>

            <div class="game-sidebar">
                <div style="padding:15px; border-bottom:1px solid #333;">
                    <h3 id="game-status-text" style="color:var(--accent); font-size:14px;">Warte auf Gegner...</h3>
                </div>
                
                <div class="chat-box">
                    <div id="chat-messages" class="chat-messages">
                        <div class="msg-system">Willkommen im Chat!</div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" id="inp-chat" placeholder="Nachricht..." style="padding:8px;">
                        <button class="btn-icon btn-primary" style="margin-left:5px;" onclick="app.social.sendChat()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <div style="padding:15px;">
                    <button class="btn btn-danger" onclick="app.game.quit()">Aufgeben / Verlassen</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-gameover" class="modal-overlay">
        <div class="modal-content animate__animated animate__zoomIn">
            <i id="go-icon" class="fas fa-trophy" style="font-size: 4em; color: var(--gold); margin-bottom: 20px;"></i>
            <h2 id="go-title">GEWONNEN!</h2>
            <p id="go-msg" style="color:#aaa;">Gut gespielt.</p>
            <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:4px; margin:20px 0; font-weight:bold; color:var(--success);">
                <span id="go-reward">+50 Münzen</span>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="$('#modal-gameover').fadeOut(); app.game.quit();">Zurück zur Lobby</button>
        </div>
    </div>

    <div id="modal-challenge" class="modal-overlay">
        <div class="modal-content animate__animated animate__pulse">
            <i class="fas fa-exclamation-circle" style="font-size: 3em; color: var(--accent);"></i>
            <h2>Herausforderung!</h2>
            <p><span id="challenger-name" style="font-weight:bold; color:white;">Unbekannt</span> fordert dich heraus.</p>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-success" style="flex:1" onclick="app.social.acceptChallenge()">Annehmen</button>
                <button class="btn btn-danger" style="flex:1" onclick="app.social.rejectChallenge()">Ablehnen</button>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // CONFIG & INIT
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAwQMhOL1tBQfU5EivFfomrTLf2dINYRZs",
            authDomain: "chess-server-d09b1.firebaseapp.com",
            projectId: "chess-server-d09b1",
            storageBucket: "chess-server-d09b1.firebasestorage.app",
            messagingSenderId: "354655053561",
            appId: "1:354655053561:web:43ea29ed1f01ee366f6428",
            measurementId: "G-B2WK6GD8Z0"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // =================================================================
        // AUDIO ENGINE (Synthesizer - Kein externer Download nötig!)
        // =================================================================
        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            playTone: function(freq, type, duration) {
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playMove: function() { this.playTone(300, 'sine', 0.1); },
            playCapture: function() { 
                this.playTone(150, 'sawtooth', 0.1); 
                setTimeout(() => this.playTone(100, 'sawtooth', 0.2), 50);
            },
            playWin: function() {
                [523.25, 659.25, 783.99, 1046.50].forEach((f, i) => setTimeout(() => this.playTone(f, 'square', 0.3), i*150));
            },
            playLose: function() {
                [300, 250, 200, 150].forEach((f, i) => setTimeout(() => this.playTone(f, 'sawtooth', 0.4), i*200));
            }
        };

        // =================================================================
        // PARTICLE ENGINE (Explosionen)
        // =================================================================
        const ParticleEngine = {
            spawn: function(x, y, color) {
                const container = document.getElementById('particle-layer');
                for(let i=0; i<20; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.backgroundColor = color;
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    
                    // Physik
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = Math.random() * 50 + 20;
                    const tx = Math.cos(angle) * velocity;
                    const ty = Math.sin(angle) * velocity;

                    p.style.transition = 'all 0.8s cubic-bezier(0.165, 0.84, 0.44, 1)';
                    container.appendChild(p);

                    // Trigger Anim
                    setTimeout(() => {
                        p.style.transform = `translate(${tx}px, ${ty}px) scale(0)`;
                        p.style.opacity = 0;
                    }, 10);

                    // Cleanup
                    setTimeout(() => p.remove(), 800);
                }
            }
        };

        // =================================================================
        // MAIN APP LOGIC
        // =================================================================
        const app = {
            state: {
                user: null,
                userData: null,
                game: new Chess(),
                board: null,
                mode: null, // 'bot' | 'online'
                room: null,
                color: 'w',
                selectedSquare: null,
                pendingChallenge: null
            },
            skins: {
                'cyber': { name: 'Cyberpunk', cost: 0, css: 'skin-cyber' },
                'ruby': { name: 'Rubin', cost: 500, css: 'skin-ruby' },
                'gold': { name: 'Prestige Gold', cost: 2000, css: 'skin-gold' }
            },

            // --- AUTH MODULE ---
            auth: {
                register: () => {
                    let u = $('#inp-username').val(), e = $('#inp-email').val(), p = $('#inp-pass').val();
                    if(!u || !e || !p) return app.ui.showError('Bitte fülle alles aus.');
                    auth.createUserWithEmailAndPassword(e, p).then(cred => {
                        // User Setup
                        let safeEmail = e.replace(/\./g, ',');
                        let uid = cred.user.uid;
                        let initData = { username: u, email: e, wins: 0, coins: 0, skin: 'cyber', unlockedSkins: ['cyber'] };
                        
                        // Atomare Updates
                        let updates = {};
                        updates['users/' + uid] = initData;
                        updates['email_index/' + safeEmail] = uid;
                        db.ref().update(updates);
                    }).catch(err => app.ui.showError(err.message));
                },
                login: () => {
                    auth.signInWithEmailAndPassword($('#inp-email').val(), $('#inp-pass').val())
                    .catch(err => app.ui.showError(err.message));
                },
                logout: () => auth.signOut().then(() => location.reload())
            },

            // --- GAME MODULE ---
            game: {
                initBoard: (type) => {
                    app.state.game.reset();
                    app.state.selectedSquare = null;
                    $('#chat-messages').html('<div class="msg-system">Spiel gestartet</div>');
                    $('#modal-gameover').hide();

                    let skin = app.state.userData.skin || 'cyber';
                    $('#board').removeClass().addClass(app.skins[skin].css);

                    let config = {
                        draggable: true,
                        position: 'start',
                        pieceTheme: piece => `https://chessboardjs.com/img/chesspieces/wikipedia/${piece}.png`,
                        onDragStart: app.game.onDragStart,
                        onDrop: type === 'bot' ? app.game.onDropBot : app.game.onDropOnline,
                        onSnapEnd: () => app.state.board.position(app.state.game.fen())
                    };
                    app.state.board = Chessboard('board', config);
                    
                    // Click Handler Setup
                    $('#board').off('click').on('click', '.square-55d63', app.game.onClickSquare);
                    
                    app.game.updateStatus();
                },

                onClickSquare: function() {
                    let square = $(this).attr('data-square');
                    // Move Logic für Klicks
                    if(app.state.selectedSquare) {
                        let move = app.game.handleMove(app.state.selectedSquare, square);
                        if(move) return;
                    }
                    
                    let piece = app.state.game.get(square);
                    if(piece && piece.color === app.state.game.turn()) {
                        // Validation
                        if(app.state.mode === 'online' && piece.color !== app.state.color.charAt(0)) return;
                        if(app.state.mode === 'bot' && piece.color === 'b') return;

                        app.state.selectedSquare = square;
                        $('.square-55d63').removeClass('highlight-current move-hint');
                        $(this).addClass('highlight-current');
                        
                        // Show Hints
                        let moves = app.state.game.moves({square: square, verbose: true});
                        moves.forEach(m => $(`.square-${m.to}`).addClass('move-hint'));
                    } else {
                        app.state.selectedSquare = null;
                        $('.square-55d63').removeClass('highlight-current move-hint');
                    }
                },

                onDragStart: (source, piece) => {
                    if(app.state.game.game_over()) return false;
                    if(app.state.mode === 'online') {
                        if(app.state.game.turn() !== app.state.color.charAt(0)) return false;
                        if(piece.charAt(0) !== app.state.color.charAt(0)) return false;
                    }
                    if(app.state.mode === 'bot' && piece.search(/^b/) !== -1) return false;
                    
                    // Clear visual hints
                    $('.square-55d63').removeClass('highlight-current move-hint');
                    app.state.selectedSquare = null;
                },

                handleMove: (from, to) => {
                    let move = null;
                    try { move = app.state.game.move({ from: from, to: to, promotion: 'q' }); } catch(e){}
                    
                    if(move) {
                        app.state.board.position(app.state.game.fen());
                        $('.square-55d63').removeClass('highlight-current move-hint');
                        app.state.selectedSquare = null;

                        // Sound & FX
                        if(move.captured) {
                            AudioEngine.playCapture();
                            let $sq = $(`.square-${to}`);
                            let offset = $sq.offset();
                            // Partikel an Position spawnen
                            if($sq.length) ParticleEngine.spawn(offset.left + 30, offset.top + 30, move.color === 'w' ? '#000' : '#fff');
                        } else {
                            AudioEngine.playMove();
                        }

                        // Sync Logic
                        if(app.state.mode === 'online') {
                            db.ref('games/' + app.state.room).set({ fen: app.state.game.fen(), lastMove: move });
                        } else if(app.state.mode === 'bot' && app.state.game.turn() === 'b') {
                            setTimeout(app.game.botMove, 500);
                        }

                        app.game.updateStatus();
                        app.game.checkGameOver();
                        return true;
                    }
                    return false;
                },

                onDropBot: (s, t) => { if(!app.game.handleMove(s,t)) return 'snapback'; },
                onDropOnline: (s, t) => { if(!app.game.handleMove(s,t)) return 'snapback'; },

                botMove: () => {
                    let moves = app.state.game.moves({verbose:true});
                    if(moves.length === 0) return;
                    let move = moves[Math.floor(Math.random() * moves.length)];
                    app.state.game.move(move.san);
                    app.state.board.position(app.state.game.fen());
                    
                    if(move.captured) {
                        AudioEngine.playCapture();
                         // Bot kill effect positions calculation is tricky without drag event, skipping exact particle pos for bot for simplicity or use fixed logic
                    } else AudioEngine.playMove();
                    
                    app.game.updateStatus();
                    app.game.checkGameOver();
                },

                checkGameOver: () => {
                    if(app.state.game.game_over()) {
                        let win = false;
                        let msg = "Unentschieden";
                        let reward = 5;

                        if(app.state.game.in_checkmate()) {
                            let winner = app.state.game.turn() === 'w' ? 'black' : 'white';
                            // Habe ich gewonnen?
                            let iWon = (app.state.mode === 'bot' && winner === 'white') ||
                                       (app.state.mode === 'online' && winner === app.state.color);
                            
                            if(iWon) {
                                win = true; msg = "Du hast gewonnen!"; reward = 50;
                                AudioEngine.playWin();
                            } else {
                                msg = "Verloren..."; reward = 5;
                                AudioEngine.playLose();
                            }
                        }

                        // UI & DB
                        $('#go-title').text(win ? "GEWONNEN!" : "GAME OVER");
                        $('#go-msg').text(msg);
                        $('#go-reward').text(`+${reward} Münzen ${win ? '| +1 Sieg' : ''}`);
                        $('#go-icon').attr('class', win ? 'fas fa-trophy' : 'fas fa-skull');
                        $('#go-icon').css('color', win ? 'var(--gold)' : '#555');
                        $('#modal-gameover').css('display', 'flex');

                        // Save Stats (Transaction Safety)
                        let uid = auth.currentUser.uid;
                        db.ref('users/'+uid).transaction(d => {
                            if(d) {
                                d.coins = (d.coins||0) + reward;
                                if(win) d.wins = (d.wins||0) + 1;
                            }
                            return d;
                        });
                    }
                },

                updateStatus: () => {
                    let status = app.state.game.turn() === 'w' ? "Weiß ist am Zug" : "Schwarz ist am Zug";
                    if(app.state.game.in_check()) status += " (SCHACH!)";
                    $('#game-status-text').text(status);
                },

                startBot: () => {
                    app.state.mode = 'bot';
                    app.ui.switchScreen('screen-game');
                    setTimeout(() => app.game.initBoard('bot'), 200);
                },

                startOnline: (color) => {
                    let r = $('#inp-room').val();
                    if(!r) return alert("Bitte Raumname eingeben");
                    app.state.mode = 'online';
                    app.state.room = r;
                    app.state.color = color;
                    app.ui.switchScreen('screen-game');
                    
                    setTimeout(() => {
                        app.game.initBoard('online');
                        if(color === 'black') app.state.board.orientation('black');
                    }, 200);

                    // DB Listener
                    app.social.initChat(r);
                    db.ref('games/'+r).off();
                    db.ref('games/'+r).on('value', snap => {
                        let d = snap.val();
                        if(d && d.fen && d.fen !== app.state.game.fen()) {
                            app.state.game.load(d.fen);
                            app.state.board.position(d.fen);
                            if(d.lastMove && d.lastMove.captured) AudioEngine.playCapture();
                            else AudioEngine.playMove();
                            app.game.updateStatus();
                            app.game.checkGameOver();
                        }
                    });
                },

                quit: () => {
                    if(app.state.mode === 'online') {
                        db.ref('games/'+app.state.room).off();
                        db.ref('chats/'+app.state.room).off();
                    }
                    app.ui.switchScreen('screen-lobby');
                }
            },

            // --- SOCIAL MODULE ---
            social: {
                addFriend: () => {
                    let email = $('#inp-friend-email').val().replace(/\./g, ',');
                    if(!email) return;
                    db.ref('email_index/'+email).once('value', snap => {
                        let uid = snap.val();
                        if(uid) {
                            if(uid === auth.currentUser.uid) return alert("Das bist du selbst.");
                            db.ref('users/'+auth.currentUser.uid+'/friends/'+uid).set(true);
                            alert("Freund hinzugefügt!");
                        } else alert("Spieler nicht gefunden.");
                    });
                },
                
                loadFriends: () => {
                    let uid = auth.currentUser.uid;
                    db.ref('users/'+uid+'/friends').on('value', snap => {
                        $('#friend-list-container').empty();
                        let friends = snap.val();
                        if(friends) {
                            Object.keys(friends).forEach(fid => {
                                db.ref('users/'+fid).once('value', usnap => {
                                    let udata = usnap.val();
                                    // Check online status
                                    db.ref('status/'+fid).on('value', ssnap => {
                                        let online = ssnap.val() && ssnap.val().state === 'online';
                                        let html = `
                                        <div class="friend-item">
                                            <div>
                                                <div class="status-indicator ${online?'is-online':'is-offline'}"></div>
                                                <b>${udata.username}</b>
                                            </div>
                                            ${online ? `<button class="btn btn-secondary btn-icon" style="width:30px;height:30px;" onclick="app.social.challenge('${fid}', '${udata.username}')"><i class="fas fa-swords"></i></button>` : '<small>Offline</small>'}
                                        </div>`;
                                        // Simple avoid duplicates logic omitted for brevity, in prod use ID check
                                        $('#friend-list-container').append(html);
                                    });
                                });
                            });
                        } else {
                            $('#friend-list-container').html('<small>Keine Freunde.</small>');
                        }
                    });
                },

                // Chat Logic
                initChat: (room) => {
                    db.ref('chats/'+room).off();
                    db.ref('chats/'+room).limitToLast(10).on('child_added', snap => {
                        let msg = snap.val();
                        let isMe = msg.uid === auth.currentUser.uid;
                        let html = `<div class="chat-msg ${isMe ? 'msg-me' : 'msg-opp'}">
                            <b>${isMe ? 'Ich' : 'Gegner'}:</b> ${msg.text}
                        </div>`;
                        let area = $('#chat-messages');
                        area.append(html);
                        area.scrollTop(area[0].scrollHeight);
                    });
                },
                sendChat: () => {
                    let txt = $('#inp-chat').val();
                    if(!txt) return;
                    db.ref('chats/'+app.state.room).push({
                        text: txt, uid: auth.currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    $('#inp-chat').val('');
                },

                // Challenge Logic
                challenge: (targetUid, name) => {
                    let roomId = 'battle_' + Date.now();
                    db.ref('challenges/'+targetUid).push({
                        from: auth.currentUser.uid,
                        fromName: app.state.userData.username,
                        roomId: roomId
                    });
                    alert(`Herausforderung an ${name} gesendet!`);
                    app.game.startOnlineGameByRoom(roomId, 'white'); // Auto-join as white
                },
                acceptChallenge: () => {
                    if(!app.state.pendingChallenge) return;
                    let c = app.state.pendingChallenge;
                    $('#modal-challenge').hide();
                    db.ref('challenges/'+auth.currentUser.uid).remove(); // Clear
                    // Start as Black
                    $('#inp-room').val(c.roomId);
                    app.game.startOnline('black');
                },
                rejectChallenge: () => {
                    $('#modal-challenge').hide();
                    db.ref('challenges/'+auth.currentUser.uid).remove();
                }
            },

            // --- UI MODULE ---
            ui: {
                showTab: (id) => {
                    $('#tab-home, #tab-shop').hide();
                    $('#tab-'+id).fadeIn();
                    if(id === 'shop') app.ui.renderShop();
                },
                switchScreen: (id) => {
                    $('.screen').removeClass('active');
                    $('#'+id).addClass('active');
                },
                showError: (msg) => {
                    $('#msg-login').text(msg).show();
                    setTimeout(() => $('#msg-login').fadeOut(), 3000);
                },
                renderShop: () => {
                    let grid = $('#shop-items');
                    grid.empty();
                    Object.keys(app.skins).forEach(k => {
                        let s = app.skins[k];
                        let owned = app.state.userData.unlockedSkins.includes(k);
                        let active = app.state.userData.skin === k;
                        
                        let btn = '';
                        if(active) btn = '<button class="btn btn-primary" disabled style="width:100%">Aktiv</button>';
                        else if(owned) btn = `<button class="btn btn-secondary" style="width:100%" onclick="app.ui.equipSkin('${k}')">Ausrüsten</button>`;
                        else btn = `<button class="btn btn-gold" style="width:100%" onclick="app.ui.buySkin('${k}')">Kaufen ${s.cost}</button>`;

                        let html = `
                        <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:4px; border:1px solid #333;">
                            <div class="${s.css}" style="height:50px; margin-bottom:10px;"></div>
                            <h4>${s.name}</h4>
                            ${btn}
                        </div>`;
                        grid.append(html);
                    });
                },
                buySkin: (key) => {
                    let cost = app.skins[key].cost;
                    if(app.state.userData.coins >= cost) {
                        if(confirm("Skin kaufen?")) {
                            let uid = auth.currentUser.uid;
                            let newSkins = [...app.state.userData.unlockedSkins, key];
                            db.ref('users/'+uid).update({
                                coins: app.state.userData.coins - cost,
                                unlockedSkins: newSkins,
                                skin: key
                            });
                        }
                    } else alert("Zu wenig Münzen!");
                },
                equipSkin: (key) => db.ref('users/'+auth.currentUser.uid).update({skin: key})
            }
        };

        // =================================================================
        // GLOBAL LISTENERS & INIT
        // =================================================================
        auth.onAuthStateChanged(user => {
            if(user) {
                // Online Presence
                let myStatus = db.ref('status/' + user.uid);
                db.ref('.info/connected').on('value', snap => {
                    if(snap.val()) {
                        myStatus.onDisconnect().set({state: 'offline'});
                        myStatus.set({state: 'online'});
                    }
                });

                // Load Data
                db.ref('users/'+user.uid).on('value', snap => {
                    app.state.userData = snap.val() || {};
                    $('#lobby-name').text(app.state.userData.username);
                    $('#lobby-wins').text(app.state.userData.wins);
                    $('#lobby-coins').text(app.state.userData.coins);
                    $('#shop-coins-display').text(app.state.userData.coins);

                    // Rank Logic
                    let w = app.state.userData.wins;
                    let r = "Bauer";
                    if(w > 5) r = "Springer";
                    if(w > 15) r = "Läufer";
                    if(w > 30) r = "Turm";
                    if(w > 50) r = "Königin";
                    if(w > 100) r = "Großmeister";
                    $('#lobby-rank').text(r);
                    
                    app.ui.switchScreen('screen-lobby');
                    app.ui.renderShop();
                });

                // Challenge Listener
                db.ref('challenges/'+user.uid).on('child_added', snap => {
                    app.state.pendingChallenge = { key: snap.key, ...snap.val() };
                    $('#challenger-name').text(app.state.pendingChallenge.fromName);
                    $('#modal-challenge').css('display', 'flex');
                });

                app.social.loadFriends();
            } else {
                app.ui.switchScreen('screen-login');
            }
        });

    </script>
</body>
</html>
